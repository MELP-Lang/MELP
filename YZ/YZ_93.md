# YZ_93: Parenthesized Expressions and Function Calls in Interpolation

**Tarih:** 15 AralÄ±k 2025  
**Durum:** âœ… TamamlandÄ±  
**Branch:** `phase18-array-support_YZ_74`  

---

## ğŸ¯ Hedef

YZ_92'de implement edilen string interpolation expression desteÄŸini geniÅŸletmek:
- **A:** Parenthesized expressions: `${(x + y) * 2}`
- **B:** Function calls: `${abs(x)}`

---

## ğŸ“‹ YapÄ±lan DeÄŸiÅŸiklikler

### 1. Function Call Type Detection (arithmetic_codegen.c)

**Sorun:** `abs(x)` gibi function call'lar interpolation iÃ§inde segfault yapÄ±yordu Ã§Ã¼nkÃ¼ sayÄ±sal sonuÃ§ doÄŸrudan `mlp_string_concat`'a geÃ§iriliyordu.

**Ã‡Ã¶zÃ¼m:** Function call'larÄ±n return type'Ä±nÄ± detect edip sayÄ±sal olanlarÄ± `mlp_number_to_string` ile dÃ¶nÃ¼ÅŸtÃ¼rmek:

```c
// YZ_93: Check if right is a function call returning numeric
if (expr->right && expr->right->is_function_call && expr->right->func_call) {
    const char* fn = expr->right->func_call->function_name;
    // String-returning functions (no conversion needed)
    if (strcmp(fn, "mlp_number_to_string") == 0 ||
        strcmp(fn, "mlp_string_concat") == 0 ||
        strcmp(fn, "get_string_at") == 0 ||
        strcmp(fn, "mlp_string_format") == 0) {
        right_is_numeric = 0;
    } else {
        // Most functions return numeric
        right_is_numeric = 1;
    }
}
```

### 2. Variable Name Reservation Issue

**Sorun:** `string text = "Hello"` ifadesi derleme hatasÄ± veriyordu.

**Sebep:** `text` kelimesi lexer'da `TOKEN_STRING_TYPE` olarak tanÄ±mlÄ± (legacy alias).

**Ã‡Ã¶zÃ¼m:** Test dosyalarÄ±nda `text` yerine `mytext` veya baÅŸka identifier kullanÄ±ldÄ±.

---

## ğŸ§ª Test SonuÃ§larÄ±

| Test DosyasÄ± | Ä°fade | Beklenen | SonuÃ§ |
|--------------|-------|----------|-------|
| `test_expr_interp_paren.mlp` | `${(x + y) * 2}` | "Result: 60" | âœ… |
| `test_expr_interp_func.mlp` | `${abs(x)}` | "Absolute: 10" | âœ… |
| `test_expr_interp_length.mlp` | `${length(mytext)}` | "Length: 5" | âœ… |
| `test_expr_interp_func_arith.mlp` | `${abs(x) + 5}` | "Result: 15" | âœ… |
| `test_expr_interp_multi.mlp` | `${x + y}, ${x * y}, ${abs(z)}` | "Sum: 30, Product: 200, Abs: 10" | âœ… |

---

## ğŸ”§ Desteklenen Ã–zellikler

### Parenthesized Expressions
```mlp
string result = "Answer: ${(a + b) * (c - d)}"
```

### Single Function Calls
```mlp
string s = "Value: ${abs(x)}"
string s = "Length: ${length(str)}"
string s = "Max: ${max(a, b)}"
string s = "Random: ${random()}"
```

### Combined Expressions
```mlp
string s = "Result: ${abs(x) + 5}"
string s = "Double: ${length(str) * 2}"
```

### Multiple Interpolations
```mlp
string s = "X=${x}, Y=${y}, Sum=${x + y}"
```

---

## âš ï¸ Bilinen KÄ±sÄ±tlamalar

1. **Nested function calls desteklenmiyor:**
   ```mlp
   -- Bu Ã§alÄ±ÅŸmaz
   string s = "${abs(min(x, y))}"
   ```

2. **`text` identifier olarak kullanÄ±lamaz:**
   ```mlp
   -- Bu Ã§alÄ±ÅŸmaz (text reserved keyword)
   string text = "Hello"
   
   -- Bunun yerine:
   string mytext = "Hello"
   ```

---

## ğŸ“ DeÄŸiÅŸtirilen Dosyalar

| Dosya | DeÄŸiÅŸiklik |
|-------|------------|
| `compiler/stage0/modules/arithmetic/arithmetic_codegen.c` | Function call type detection eklendi |
| `tests/manual/test_expr_interp_paren.mlp` | Test dosyasÄ± (yeni) |
| `tests/manual/test_expr_interp_func.mlp` | Test dosyasÄ± (yeni) |
| `tests/manual/test_expr_interp_length.mlp` | Test dosyasÄ± (yeni) |
| `tests/manual/test_expr_interp_func_arith.mlp` | Test dosyasÄ± (yeni) |
| `tests/manual/test_expr_interp_multi.mlp` | Test dosyasÄ± (yeni) |

---

## ğŸ”— Ä°lgili Oturumlar

- **YZ_92:** Temel expression interpolation implementasyonu
- **YZ_91:** `mlp_number_to_string` register clobbering fix

---

## ğŸ“Š SonuÃ§

YZ_93 oturumunda:
- âœ… Parenthesized expressions tam Ã§alÄ±ÅŸÄ±yor
- âœ… Function calls tam Ã§alÄ±ÅŸÄ±yor
- âœ… Combined expressions (function + arithmetic) Ã§alÄ±ÅŸÄ±yor
- âœ… Multiple interpolations Ã§alÄ±ÅŸÄ±yor
- âœ… TÃ¼m testler geÃ§ti
- âš ï¸ Nested function calls ÅŸimdilik desteklenmiyor (gelecek geliÅŸtirme)

**String interpolation expression desteÄŸi production-ready!** ğŸ‰
