// Ana Uygulama

// Global designer instance
let designer;

// Uygulama baÅŸlangÄ±cÄ±
document.addEventListener('DOMContentLoaded', async () => {
  designer = new Designer();

  // Config dosyalarÄ±nÄ± yÃ¼kle
  showStatus('Dil ve syntax yapÄ±landÄ±rmalarÄ± yÃ¼kleniyor...');
  const configLoaded = await configLoader.loadConfigs();

  if (configLoaded) {
    populateLanguageSelector();
    populateSyntaxSelector();

    // MLP keyword'lerini IntelliSense'e yÃ¼kle (setTimeout ile gecikme)
    setTimeout(() => {
      try {
        if (typeof intelliSense !== 'undefined' && intelliSense.loadKeywords) {
          const mlpKeywords = [
            'numeric', 'string', 'boolean', 'pointer',
            'function', 'end', 'return',
            'if', 'else', 'then', 'elif',
            'while', 'for', 'in', 'break', 'continue', 'stop',
            'struct', 'enum', 'const',
            'lambda', 'map', 'list', 'optional',
            'import', 'export', 'module',
            'true', 'false', 'null',
            'and', 'or', 'not',
            'print', 'typeof', 'range'
          ];
          intelliSense.loadKeywords(mlpKeywords);
          console.log('IntelliSense keywords loaded:', mlpKeywords.length);
        } else {
          console.error('IntelliSense object not available!');
        }
      } catch (error) {
        console.error('Error loading IntelliSense keywords:', error);
      }
    }, 500);
  }

  initializeUI();
  loadSavedTheme(); // KaydedilmiÅŸ temayÄ± yÃ¼kle
  showStatus('MLP GUI Designer hazÄ±r');
});

// UI event listener'larÄ±nÄ± baÅŸlat
function initializeUI() {
  // Tab geÃ§iÅŸleri
  const tabDesign = document.getElementById('tab-design');
  const tabCode = document.getElementById('tab-code');
  const viewDesign = document.getElementById('view-design');
  const viewCode = document.getElementById('view-code');
  const codeEditor = document.getElementById('code-editor');

  tabDesign.addEventListener('click', () => {
    tabDesign.classList.add('active');
    tabCode.classList.remove('active');
    viewDesign.classList.remove('hidden');
    viewCode.classList.add('hidden');
    showStatus('TasarÄ±m gÃ¶rÃ¼nÃ¼mÃ¼');
  });

  tabCode.addEventListener('click', () => {
    tabCode.classList.add('active');
    tabDesign.classList.remove('active');
    viewCode.classList.remove('hidden');
    viewDesign.classList.add('hidden');

    // Kodu gÃ¼ncelle
    updateCodeView();
    showStatus('Kod gÃ¶rÃ¼nÃ¼mÃ¼');
  });

  // Dosya menÃ¼sÃ¼
  document.getElementById('menu-new').addEventListener('click', handleNewProject);
  document.getElementById('menu-open').addEventListener('click', handleOpenProject);
  document.getElementById('menu-save').addEventListener('click', handleSaveProject);
  document.getElementById('menu-export').addEventListener('click', handleExportCode);

  // DÃ¼zenle menÃ¼sÃ¼
  document.getElementById('menu-undo').addEventListener('click', handleUndo);
  document.getElementById('menu-redo').addEventListener('click', handleRedo);
  document.getElementById('menu-cut').addEventListener('click', handleCut);
  document.getElementById('menu-copy').addEventListener('click', handleCopy);
  document.getElementById('menu-paste').addEventListener('click', handlePaste);
  document.getElementById('menu-delete').addEventListener('click', handleDelete);
  document.getElementById('menu-select-all').addEventListener('click', handleSelectAll);

  // GÃ¶rÃ¼nÃ¼m menÃ¼sÃ¼
  document.getElementById('menu-toggle-theme').addEventListener('click', handleToggleTheme);
  document.getElementById('menu-toggle-toolbox').addEventListener('click', handleToggleToolbox);
  document.getElementById('menu-toggle-properties').addEventListener('click', handleToggleProperties);
  document.getElementById('menu-zoom-in').addEventListener('click', handleZoomIn);
  document.getElementById('menu-zoom-out').addEventListener('click', handleZoomOut);
  document.getElementById('menu-zoom-reset').addEventListener('click', handleZoomReset);
  document.getElementById('menu-toggle-grid').addEventListener('click', handleToggleGrid);

  // YardÄ±m menÃ¼sÃ¼
  document.getElementById('menu-quickstart').addEventListener('click', handleQuickstart);
  document.getElementById('menu-keyboard-shortcuts').addEventListener('click', handleKeyboardShortcuts);
  document.getElementById('menu-mlp-functions').addEventListener('click', handleMlpFunctions);
  document.getElementById('menu-documentation').addEventListener('click', handleDocumentation);
  document.getElementById('menu-mlp-docs').addEventListener('click', handleMlpDocs);
  document.getElementById('menu-about').addEventListener('click', handleAbout);

  // Toolbar butonlarÄ±
  document.getElementById('btn-new').addEventListener('click', handleNewProject);
  document.getElementById('btn-open').addEventListener('click', handleOpenProject);
  document.getElementById('btn-save').addEventListener('click', handleSaveProject);
  document.getElementById('btn-export').addEventListener('click', handleExportCode);
  document.getElementById('btn-run').addEventListener('click', handleRun);

  // Dil ve Syntax seÃ§iciler
  document.getElementById('language-selector').addEventListener('change', handleLanguageChange);
  document.getElementById('syntax-selector').addEventListener('change', handleSyntaxChange);

  // Code editor'da yazÄ± yazÄ±lÄ±nca validation yap
  codeEditor.addEventListener('input', () => {
    // SatÄ±r numaralarÄ±nÄ± hemen gÃ¼ncelle
    updateLineNumbers();

    // KÄ±sa bir gecikme ile validate et (her tuÅŸ vuruÅŸunda deÄŸil)
    clearTimeout(window.validationTimeout);
    window.validationTimeout = setTimeout(() => {
      validateAndHighlightCode();
    }, 500); // 500ms bekle
  });

  // Code editor'da IntelliSense iÃ§in klavye event'leri
  codeEditor.addEventListener('keydown', (e) => {
    // Ctrl+Space - IntelliSense'i manuel olarak aÃ§
    if (e.ctrlKey && e.code === 'Space') {
      e.preventDefault();
      const pos = intelliSense.getCursorPosition(codeEditor);
      intelliSense.show(codeEditor, pos);
      return;
    }

    // IntelliSense aÃ§Ä±ksa
    if (intelliSense.isVisible) {
      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          intelliSense.selectNext();
          break;
        case 'ArrowUp':
          e.preventDefault();
          intelliSense.selectPrevious();
          break;
        case 'Enter':
        case 'Tab':
          e.preventDefault();
          intelliSense.insertSelected();
          break;
        case 'Escape':
          e.preventDefault();
          intelliSense.cancel();
          break;
      }
    }
  });

  // Code editor'da yazarken otomatik IntelliSense
  codeEditor.addEventListener('keyup', (e) => {
    // Ã–zel tuÅŸlarÄ± atla
    if (['ArrowDown', 'ArrowUp', 'Enter', 'Tab', 'Escape', 'Shift', 'Control', 'Alt'].includes(e.key)) {
      return;
    }

    // Harf veya _ yazÄ±ldÄ±ysa IntelliSense'i gÃ¶ster
    if (e.key.match(/^[a-zA-Z_]$/)) {
      clearTimeout(window.intellisenseTimeout);
      window.intellisenseTimeout = setTimeout(() => {
        const pos = intelliSense.getCursorPosition(codeEditor);
        const line = intelliSense.getLineText(pos.line);
        const wordBefore = intelliSense.getWordBeforeCursor(line, pos.column);

        // En az 2 karakter yazÄ±lmÄ±ÅŸsa gÃ¶ster
        if (wordBefore.length >= 2) {
          intelliSense.show(codeEditor, pos);
        }
      }, 300);
    } else {
      // BoÅŸluk, noktalama vs - IntelliSense'i kapat
      intelliSense.hide();
    }
  });

  // EditÃ¶r dÄ±ÅŸÄ±na tÄ±klanÄ±nca IntelliSense'i kapat
  document.addEventListener('click', (e) => {
    if (!intelliSense.popup.contains(e.target) && e.target !== codeEditor) {
      intelliSense.hide();
    }
  });
}

// Dil seÃ§iciyi doldur
function populateLanguageSelector() {
  const selector = document.getElementById('language-selector');
  const languages = configLoader.getLanguages();

  // Clear existing options
  selector.innerHTML = '';

  languages.forEach(lang => {
    const option = document.createElement('option');
    option.value = lang.id;
    option.textContent = lang.name;
    if (lang.id === configLoader.currentLanguage) {
      option.selected = true;
    }
    selector.appendChild(option);
  });
}

// Syntax seÃ§iciyi doldur
function populateSyntaxSelector() {
  const selector = document.getElementById('syntax-selector');
  const syntaxes = configLoader.getSyntaxes();

  // Clear existing options
  selector.innerHTML = '';

  Object.values(syntaxes).forEach(syntax => {
    const option = document.createElement('option');
    option.value = syntax.id;
    option.textContent = syntax.name;
    if (syntax.id === configLoader.currentSyntax) {
      option.selected = true;
    }
    selector.appendChild(option);
  });
}

// Dil deÄŸiÅŸti
function handleLanguageChange(e) {
  const langId = e.target.value;
  configLoader.setLanguage(langId);
  showStatus(`Dil deÄŸiÅŸtirildi: ${configLoader.getCurrentLanguage().name}`);

  // Kod gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§Ä±ksa gÃ¼ncelle
  if (!document.getElementById('view-code').classList.contains('hidden')) {
    updateCodeView();
  }
}

// Syntax deÄŸiÅŸti
function handleSyntaxChange(e) {
  const syntaxId = e.target.value;
  configLoader.setSyntax(syntaxId);
  showStatus(`Syntax deÄŸiÅŸtirildi: ${configLoader.getCurrentSyntax().name}`);

  // Kod gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§Ä±ksa gÃ¼ncelle
  if (!document.getElementById('view-code').classList.contains('hidden')) {
    updateCodeView();
  }
}

// Kod gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
function updateCodeView() {
  const codeEditor = document.getElementById('code-editor');
  const code = designer.generateCode();
  codeEditor.textContent = code;

  // SatÄ±r numaralarÄ±nÄ± gÃ¼ncelle
  updateLineNumbers();

  // Syntax validation yap
  validateAndHighlightCode();
}

// SatÄ±r numaralarÄ±nÄ± gÃ¼ncelle
function updateLineNumbers() {
  const codeEditor = document.getElementById('code-editor');
  const lineNumbersDiv = document.getElementById('line-numbers');

  if (!lineNumbersDiv) return;

  const code = codeEditor.textContent;
  const lines = code.split('\n');

  // SatÄ±r numaralarÄ±nÄ± oluÅŸtur
  let lineNumbersHTML = '';
  for (let i = 1; i <= lines.length; i++) {
    lineNumbersHTML += `<div class="line-number">${i}</div>`;
  }

  lineNumbersDiv.innerHTML = lineNumbersHTML;

  // HatalÄ± satÄ±rlarÄ± iÅŸaretle
  const errors = syntaxValidator.getAllErrors();
  errors.forEach(err => {
    const lineNum = err.line;
    const lineElement = lineNumbersDiv.children[lineNum - 1];
    if (lineElement && err.severity === 'error') {
      lineElement.classList.add('error-line');
    }
  });
}

// Kodu validate et ve hatalarÄ± gÃ¶ster
function validateAndHighlightCode() {
  const codeEditor = document.getElementById('code-editor');
  const code = codeEditor.textContent;

  // Validate
  const errors = syntaxValidator.validate(code);

  // Error panel'i gÃ¼ncelle
  displayErrors(errors);

  // HatalarÄ± kod iÃ§inde highlight et
  if (errors.length > 0) {
    highlightErrors(code, errors);
  }

  // SatÄ±r numaralarÄ±nÄ± gÃ¼ncelle
  updateLineNumbers();
}

// HatalarÄ± error panel'de gÃ¶ster
function displayErrors(errors) {
  const viewCode = document.getElementById('view-code');
  let errorPanel = viewCode.querySelector('.error-panel');

  // Error panel yoksa oluÅŸtur
  if (!errorPanel) {
    errorPanel = document.createElement('div');
    errorPanel.className = 'error-panel';
    viewCode.appendChild(errorPanel);
  }

  // Temizle
  errorPanel.innerHTML = '';

  if (errors.length === 0) {
    errorPanel.style.display = 'none';
    return;
  }

  errorPanel.style.display = 'block';

  // HatalarÄ± listele
  errors.forEach(err => {
    const errorItem = document.createElement('div');
    errorItem.className = `error-item error-${err.severity}`;
    errorItem.innerHTML = `
      <span class="error-line">SatÄ±r ${err.line}:</span>
      <span class="error-message">${err.message}</span>
    `;

    // TÄ±klanÄ±nca o satÄ±ra git
    errorItem.addEventListener('click', () => {
      scrollToLine(err.line);
    });

    errorPanel.appendChild(errorItem);
  });
}

// HatalarÄ± kod iÃ§inde highlight et
function highlightErrors(code, errors) {
  const codeEditor = document.getElementById('code-editor');
  const lines = code.split('\n');

  // HTML ile satÄ±r satÄ±r render et
  let html = '';

  lines.forEach((line, index) => {
    const lineNum = index + 1;
    const lineErrors = errors.filter(err => err.line === lineNum);

    if (lineErrors.length > 0) {
      // HatalÄ± satÄ±r
      const severity = lineErrors[0].severity;
      html += `<div class="code-line error-line-${severity}" title="${lineErrors.map(e => e.message).join(', ')}">${escapeHtml(line)}</div>`;
    } else {
      html += `<div class="code-line">${escapeHtml(line)}</div>`;
    }
  });

  codeEditor.innerHTML = html;
}

// Belirli satÄ±ra scroll et
function scrollToLine(lineNum) {
  const codeEditor = document.getElementById('code-editor');
  const lines = codeEditor.querySelectorAll('.code-line');

  if (lines[lineNum - 1]) {
    lines[lineNum - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
    lines[lineNum - 1].classList.add('highlight-flash');

    setTimeout(() => {
      lines[lineNum - 1].classList.remove('highlight-flash');
    }, 2000);
  }
}

// HTML escape
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Fonksiyonu highlight et ve scroll et
function highlightFunction(functionName) {
  const codeEditor = document.getElementById('code-editor');
  const code = codeEditor.textContent;

  // Fonksiyon tanÄ±mÄ±nÄ± bul (Ã¶rn: "func butona_tikla() -> numeric")
  const functionPattern = new RegExp(`func\\s+${functionName}\\s*\\(`, 'i');
  const match = code.match(functionPattern);

  if (!match) {
    console.warn(`Function "${functionName}" not found in code`);
    return;
  }

  // Fonksiyonun baÅŸladÄ±ÄŸÄ± pozisyonu bul
  const functionStartIndex = match.index;

  // Fonksiyon satÄ±rÄ±nÄ± bul (Ã¶nceki satÄ±r sayÄ±sÄ±nÄ± hesapla)
  const codeBeforeFunction = code.substring(0, functionStartIndex);
  const lineNumber = codeBeforeFunction.split('\n').length;

  // Kod editor'deki satÄ±rlar
  const lines = code.split('\n');

  // Highlight iÃ§in geÃ§ici marker ekle
  const viewCode = document.getElementById('view-code');
  const codeContainer = viewCode.querySelector('.code-container') || viewCode;

  // SatÄ±r yÃ¼ksekliÄŸini hesapla (yaklaÅŸÄ±k 20px per line)
  const lineHeight = 20;
  const scrollPosition = (lineNumber - 3) * lineHeight; // 3 satÄ±r padding

  // Scroll to position
  codeContainer.scrollTop = Math.max(0, scrollPosition);

  // Visual feedback: Highlight the function temporarily
  const originalHTML = codeEditor.innerHTML;
  const highlightedCode = code.replace(
    functionPattern,
    '<mark style="background-color: #4a90e2; color: white; padding: 2px 4px; border-radius: 3px;">$&</mark>'
  );

  codeEditor.innerHTML = highlightedCode;

  // Remove highlight after 2 seconds
  setTimeout(() => {
    codeEditor.textContent = code;
  }, 2000);

  showStatus(`Fonksiyon bulundu: ${functionName}() - SatÄ±r ${lineNumber}`);
}

// Yeni proje
async function handleNewProject() {
  if (designer.widgets.length > 0) {
    const result = await window.electronAPI.newProject();
    if (!result.confirmed) return;
  }

  designer.clear();
  showStatus('Yeni proje oluÅŸturuldu');
}

// Proje aÃ§
async function handleOpenProject() {
  try {
    const result = await window.electronAPI.openProject();

    if (result.success && result.data) {
      designer.loadFromJSON(result.data);
      showStatus('Proje aÃ§Ä±ldÄ±: ' + result.filePath);
    } else if (result.error) {
      alert('Proje aÃ§Ä±lÄ±rken hata: ' + result.error);
    }
  } catch (error) {
    console.error('Proje aÃ§ma hatasÄ±:', error);
    alert('Proje aÃ§Ä±lÄ±rken bir hata oluÅŸtu');
  }
}

// Proje kaydet
async function handleSaveProject() {
  try {
    const projectData = designer.toJSON();
    const result = await window.electronAPI.saveProject(projectData);

    if (result.success) {
      showStatus('Proje kaydedildi: ' + result.filePath);
    } else if (result.error) {
      alert('Proje kaydedilirken hata: ' + result.error);
    }
  } catch (error) {
    console.error('Proje kaydetme hatasÄ±:', error);
    alert('Proje kaydedilirken bir hata oluÅŸtu');
  }
}

// MLP kodunu dÄ±ÅŸa aktar
async function handleExportCode() {
  try {
    const mlpCode = designer.generateCode();
    const result = await window.electronAPI.exportMlpCode(mlpCode);

    if (result.success) {
      showStatus('MLP kodu dÄ±ÅŸa aktarÄ±ldÄ±: ' + result.filePath);
    } else if (result.error) {
      alert('Kod dÄ±ÅŸa aktarÄ±lÄ±rken hata: ' + result.error);
    }
  } catch (error) {
    console.error('Kod dÄ±ÅŸa aktarma hatasÄ±:', error);
    alert('Kod dÄ±ÅŸa aktarÄ±lÄ±rken bir hata oluÅŸtu');
  }
}

// Ã‡alÄ±ÅŸtÄ±r (Ã¶nizleme)
function handleRun() {
  // Kod gÃ¶rÃ¼nÃ¼mÃ¼ne geÃ§ ve kodu gÃ¶ster
  const tabCode = document.getElementById('tab-code');
  tabCode.click();
  showStatus('Kod oluÅŸturuldu - MLP derleyicisi ile Ã§alÄ±ÅŸtÄ±rabilirsiniz');

  // Bilgilendirme mesajÄ±
  setTimeout(() => {
    alert(
      'MLP GUI Kodu OluÅŸturuldu!\n\n' +
      'Kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in:\n' +
      '1. "Dosya > MLP Kodu DÄ±ÅŸa Aktar" ile .mlp dosyasÄ± olarak kaydedin\n' +
      '2. MLP derleyicisi ile derleyin: mlpc gui_program.mlp\n' +
      '3. Ã‡alÄ±ÅŸtÄ±rÄ±n: ./gui_program\n\n' +
      'Not: MLP GUI runtime fonksiyonlarÄ±nÄ±n yÃ¼klÃ¼ olmasÄ± gerekir.'
    );
  }, 500);
}

// Klavye kÄ±sayollarÄ±
document.addEventListener('keydown', (e) => {
  // Ctrl+S: Kaydet
  if (e.ctrlKey && e.key === 's') {
    e.preventDefault();
    handleSaveProject();
  }

  // Ctrl+O: AÃ§
  if (e.ctrlKey && e.key === 'o') {
    e.preventDefault();
    handleOpenProject();
  }

  // Ctrl+N: Yeni
  if (e.ctrlKey && e.key === 'n') {
    e.preventDefault();
    handleNewProject();
  }

  // Ctrl+E: DÄ±ÅŸa aktar
  if (e.ctrlKey && e.key === 'e') {
    e.preventDefault();
    handleExportCode();
  }

  // F5: Ã‡alÄ±ÅŸtÄ±r
  if (e.key === 'F5') {
    e.preventDefault();
    handleRun();
  }

  // Ctrl+Z: Geri al
  if (e.ctrlKey && e.key === 'z') {
    e.preventDefault();
    handleUndo();
  }

  // Ctrl+Y: Yinele
  if (e.ctrlKey && e.key === 'y') {
    e.preventDefault();
    handleRedo();
  }

  // Ctrl+X: Kes
  if (e.ctrlKey && e.key === 'x') {
    e.preventDefault();
    handleCut();
  }

  // Ctrl+C: Kopyala
  if (e.ctrlKey && e.key === 'c') {
    e.preventDefault();
    handleCopy();
  }

  // Ctrl+V: YapÄ±ÅŸtÄ±r
  if (e.ctrlKey && e.key === 'v') {
    e.preventDefault();
    handlePaste();
  }
});

// MenÃ¼ dropdown'larÄ±
document.querySelectorAll('.menu-item').forEach(item => {
  let timeout;

  item.addEventListener('mouseenter', () => {
    clearTimeout(timeout);
    const dropdown = item.querySelector('.menu-dropdown');
    if (dropdown) {
      dropdown.style.display = 'block';
    }
  });

  item.addEventListener('mouseleave', () => {
    const dropdown = item.querySelector('.menu-dropdown');
    if (dropdown) {
      timeout = setTimeout(() => {
        dropdown.style.display = 'none';
      }, 200);
    }
  });
});

// ==================== DÃœZENLE MENÃœSÃœ ====================

// Undo/Redo iÃ§in basit history sistemi
let undoStack = [];
let redoStack = [];

function saveToUndoStack() {
  if (designer && designer.widgets) {
    undoStack.push(JSON.stringify(designer.toJSON()));
    redoStack = []; // Yeni deÄŸiÅŸiklik yapÄ±ldÄ±ÄŸÄ±nda redo stack'i temizle
    if (undoStack.length > 50) { // Max 50 undo
      undoStack.shift();
    }
  }
}

function handleUndo() {
  if (undoStack.length === 0) {
    showStatus('Geri alÄ±nacak iÅŸlem yok');
    return;
  }

  // Mevcut durumu redo stack'e kaydet
  redoStack.push(JSON.stringify(designer.toJSON()));

  // Son durumu geri yÃ¼kle
  const prevState = undoStack.pop();
  designer.loadFromJSON(JSON.parse(prevState));
  showStatus('Geri alÄ±ndÄ±');
}

function handleRedo() {
  if (redoStack.length === 0) {
    showStatus('Yinelenecek iÅŸlem yok');
    return;
  }

  // Mevcut durumu undo stack'e kaydet
  undoStack.push(JSON.stringify(designer.toJSON()));

  // Redo durumunu geri yÃ¼kle
  const nextState = redoStack.pop();
  designer.loadFromJSON(JSON.parse(nextState));
  showStatus('Yinelendi');
}

let clipboard = null;

function handleCut() {
  if (!designer.selectedWidget) {
    showStatus('Kesilecek widget seÃ§ilmedi');
    return;
  }
  clipboard = JSON.stringify(designer.selectedWidget.toJSON());
  designer.deleteWidget(designer.selectedWidget);
  showStatus('Widget kesildi');
}

function handleCopy() {
  if (!designer.selectedWidget) {
    showStatus('Kopyalanacak widget seÃ§ilmedi');
    return;
  }
  clipboard = JSON.stringify(designer.selectedWidget.toJSON());
  showStatus('Widget kopyalandÄ±');
}

function handlePaste() {
  if (!clipboard) {
    showStatus('YapÄ±ÅŸtÄ±rÄ±lacak widget yok');
    return;
  }
  try {
    const widgetData = JSON.parse(clipboard);
    // Yeni pozisyonda yapÄ±ÅŸtÄ±r (biraz kaydÄ±r)
    widgetData.properties.x += 20;
    widgetData.properties.y += 20;
    const widget = Widget.fromJSON(widgetData);
    designer.addWidget(widget);
    showStatus('Widget yapÄ±ÅŸtÄ±rÄ±ldÄ±');
  } catch (error) {
    showStatus('YapÄ±ÅŸtÄ±rma hatasÄ±');
  }
}

function handleDelete() {
  if (!designer.selectedWidget) {
    showStatus('Silinecek widget seÃ§ilmedi');
    return;
  }
  designer.deleteWidget(designer.selectedWidget);
}

function handleSelectAll() {
  showStatus('TÃ¼mÃ¼nÃ¼ seÃ§ Ã¶zelliÄŸi yakÄ±nda eklenecek');
}

// ==================== GÃ–RÃœNÃœM MENÃœSÃœ ====================

let currentTheme = 'dark'; // VarsayÄ±lan: dark

function handleToggleTheme() {
  const body = document.body;

  if (currentTheme === 'dark') {
    body.classList.add('light-theme');
    currentTheme = 'light';
    showStatus('Light tema aktif');

    // Grid rengini gÃ¼ncelle
    if (gridVisible) {
      const canvas = document.getElementById('canvas');
      canvas.style.backgroundImage =
        'linear-gradient(rgba(0,0,0,.05) 1px, transparent 1px), ' +
        'linear-gradient(90deg, rgba(0,0,0,.05) 1px, transparent 1px)';
    }
  } else {
    body.classList.remove('light-theme');
    currentTheme = 'dark';
    showStatus('Dark tema aktif');

    // Grid rengini gÃ¼ncelle
    if (gridVisible) {
      const canvas = document.getElementById('canvas');
      canvas.style.backgroundImage =
        'linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px), ' +
        'linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px)';
    }
  }

  // Local storage'a kaydet
  try {
    localStorage.setItem('mlp-gui-designer-theme', currentTheme);
  } catch (e) {
    // Ignore localStorage errors
  }
}

// Sayfa yÃ¼klendiÄŸinde kaydedilmiÅŸ temayÄ± yÃ¼kle
function loadSavedTheme() {
  try {
    const savedTheme = localStorage.getItem('mlp-gui-designer-theme');
    if (savedTheme === 'light') {
      handleToggleTheme(); // Light tema geÃ§
    }
  } catch (e) {
    // Ignore localStorage errors
  }
}

function handleToggleToolbox() {
  const leftPanel = document.querySelector('.left-panel');
  if (leftPanel.style.display === 'none') {
    leftPanel.style.display = 'flex';
    showStatus('Widget araÃ§larÄ± gÃ¶steriliyor');
  } else {
    leftPanel.style.display = 'none';
    showStatus('Widget araÃ§larÄ± gizlendi');
  }
}

function handleToggleProperties() {
  const rightPanel = document.querySelector('.right-panel');
  if (rightPanel.style.display === 'none') {
    rightPanel.style.display = 'flex';
    showStatus('Ã–zellikler gÃ¶steriliyor');
  } else {
    rightPanel.style.display = 'none';
    showStatus('Ã–zellikler gizlendi');
  }
}

let currentZoom = 1.0;

function handleZoomIn() {
  currentZoom = Math.min(currentZoom + 0.1, 2.0);
  applyZoom();
  showStatus(`Zoom: ${Math.round(currentZoom * 100)}%`);
}

function handleZoomOut() {
  currentZoom = Math.max(currentZoom - 0.1, 0.5);
  applyZoom();
  showStatus(`Zoom: ${Math.round(currentZoom * 100)}%`);
}

function handleZoomReset() {
  currentZoom = 1.0;
  applyZoom();
  showStatus('Zoom sÄ±fÄ±rlandÄ± (100%)');
}

function applyZoom() {
  const canvas = document.getElementById('canvas');
  canvas.style.transform = `scale(${currentZoom})`;
  canvas.style.transformOrigin = 'top left';
}

let gridVisible = true;

function handleToggleGrid() {
  const canvas = document.getElementById('canvas');
  gridVisible = !gridVisible;

  if (gridVisible) {
    canvas.style.backgroundImage =
      'linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px), ' +
      'linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px)';
    showStatus('Izgara gÃ¶steriliyor');
  } else {
    canvas.style.backgroundImage = 'none';
    showStatus('Izgara gizlendi');
  }
}

// ==================== YARDIM MENÃœSÃœ ====================

function handleQuickstart() {
  const message = `
ğŸš€ MLP GUI Designer - HÄ±zlÄ± BaÅŸlangÄ±Ã§

1ï¸âƒ£ Widget Ekleme:
   - Sol panelden widget seÃ§in
   - Ã‡alÄ±ÅŸma alanÄ±na sÃ¼rÃ¼kleyin

2ï¸âƒ£ Widget DÃ¼zenleme:
   - TaÅŸÄ±mak iÃ§in sÃ¼rÃ¼kleyin
   - KÃ¶ÅŸelerden boyutlandÄ±rÄ±n
   - SaÄŸ panelde Ã¶zellikleri dÃ¼zenleyin

3ï¸âƒ£ Event Handler:
   - Widget seÃ§in
   - SaÄŸ panel > Olaylar
   - Fonksiyon adÄ± girin

4ï¸âƒ£ Kod Ãœretme:
   - Ctrl+E veya Dosya > DÄ±ÅŸa Aktar
   - .mlp dosyasÄ± kaydedin
   - mlpc ile derleyin

5ï¸âƒ£ Klavye KÄ±sayollarÄ±:
   - Ctrl+S: Kaydet
   - Ctrl+N: Yeni
   - Ctrl+O: AÃ§
   - Delete: Sil

DetaylÄ± bilgi iÃ§in YardÄ±m > DokÃ¼mantasyon
  `;
  alert(message);
}

function handleKeyboardShortcuts() {
  const message = `
âŒ¨ï¸ Klavye KÄ±sayollarÄ±

ğŸ“ Dosya:
  Ctrl+N  - Yeni proje
  Ctrl+O  - Proje aÃ§
  Ctrl+S  - Kaydet
  Ctrl+E  - MLP kodu dÄ±ÅŸa aktar
  F5      - Kodu gÃ¶ster/Ã§alÄ±ÅŸtÄ±r

âœ‚ï¸ DÃ¼zenle:
  Ctrl+Z  - Geri al
  Ctrl+Y  - Yinele
  Ctrl+X  - Kes
  Ctrl+C  - Kopyala
  Ctrl+V  - YapÄ±ÅŸtÄ±r
  Delete  - Sil

ğŸ‘ï¸ GÃ¶rÃ¼nÃ¼m:
  +       - YakÄ±nlaÅŸtÄ±r
  -       - UzaklaÅŸtÄ±r

ğŸ–±ï¸ Widget Ä°ÅŸlemleri:
  SÃ¼rÃ¼kle      - TaÅŸÄ±
  KÃ¶ÅŸe SÃ¼rÃ¼kle - BoyutlandÄ±r
  Ã‡ift TÄ±k     - Kod gÃ¶rÃ¼nÃ¼mÃ¼ne geÃ§
  Delete       - Sil
  `;
  alert(message);
}

async function handleMlpFunctions() {
  try {
    // mlp_functions.json'dan fonksiyonlarÄ± yÃ¼kle
    const response = await fetch('./mlp_functions.json');
    const data = await response.json();

    // Modal dialog oluÅŸtur
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-dialog" style="max-width: 900px; max-height: 80vh;">
        <div class="modal-header">
          <h2>ğŸ”§ MLP FonksiyonlarÄ±</h2>
          <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ–</button>
        </div>
        <div class="modal-body" style="overflow-y: auto; max-height: 60vh;">
          <div class="functions-search">
            <input type="text" id="function-search" placeholder="ğŸ” Fonksiyon ara..." style="width: 100%; padding: 8px; margin-bottom: 12px; font-size: 14px;">
          </div>
          <div id="functions-list"></div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    // FonksiyonlarÄ± listele
    const listContainer = modal.querySelector('#functions-list');
    renderFunctions(data, listContainer);

    // Arama fonksiyonu
    const searchInput = modal.querySelector('#function-search');
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      renderFunctions(data, listContainer, query);
    });

    // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });

  } catch (error) {
    console.error('MLP Functions loading error:', error);
    alert('MLP fonksiyonlarÄ± yÃ¼klenemedi. Dosya: mlp_functions.json');
  }
}

function renderFunctions(data, container, searchQuery = '') {
  container.innerHTML = '';

  // Kategorilere gÃ¶re grupla
  for (const [categoryName, categoryData] of Object.entries(data.categories)) {
    const functions = categoryData.functions.filter(fn => {
      if (!searchQuery) return true;
      return fn.name.toLowerCase().includes(searchQuery) ||
             fn.description.toLowerCase().includes(searchQuery);
    });

    if (functions.length === 0) continue;

    // Kategori baÅŸlÄ±ÄŸÄ±
    const categoryDiv = document.createElement('div');
    categoryDiv.style.marginBottom = '24px';
    categoryDiv.innerHTML = `
      <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 6px; margin-bottom: 12px;">
        ${categoryData.icon} ${categoryData.name}
      </h3>
    `;

    // Fonksiyonlar
    functions.forEach(fn => {
      const fnDiv = document.createElement('div');
      fnDiv.style.marginBottom = '16px';
      fnDiv.style.padding = '12px';
      fnDiv.style.backgroundColor = 'var(--bg-secondary)';
      fnDiv.style.borderRadius = '6px';
      fnDiv.style.borderLeft = '4px solid var(--accent-color)';

      fnDiv.innerHTML = `
        <div style="font-family: 'Courier New', monospace; font-weight: bold; color: var(--accent-color); margin-bottom: 6px;">
          ${fn.signature}
        </div>
        <div style="color: var(--text-secondary); margin-bottom: 8px; font-size: 13px;">
          ${fn.description}
        </div>
        ${fn.params && fn.params.length > 0 ? `
          <div style="font-size: 12px; margin-top: 8px;">
            <strong>Parametreler:</strong>
            <ul style="margin: 4px 0 0 20px; padding: 0;">
              ${fn.params.map(p => `
                <li><code>${p.name}</code> (${p.type}): ${p.description}</li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        ${fn.returns ? `
          <div style="font-size: 12px; margin-top: 6px;">
            <strong>DÃ¶ndÃ¼rÃ¼r:</strong> (${fn.returns.type}) ${fn.returns.description}
          </div>
        ` : ''}
        ${fn.example ? `
          <details style="margin-top: 8px; font-size: 12px;">
            <summary style="cursor: pointer; color: var(--accent-color);">ğŸ“ Ã–rnek Kod</summary>
            <pre style="background: var(--bg-tertiary); padding: 8px; border-radius: 4px; margin-top: 6px; overflow-x: auto;"><code>${fn.example}</code></pre>
          </details>
        ` : ''}
      `;

      categoryDiv.appendChild(fnDiv);
    });

    container.appendChild(categoryDiv);
  }

  // Sabitler varsa ekle
  if (data.constants && data.constants.length > 0) {
    const constantsDiv = document.createElement('div');
    constantsDiv.style.marginBottom = '24px';
    constantsDiv.innerHTML = `
      <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 6px; margin-bottom: 12px;">
        ğŸ“Œ Sabitler
      </h3>
    `;

    data.constants.forEach(c => {
      const constDiv = document.createElement('div');
      constDiv.style.marginBottom = '8px';
      constDiv.style.padding = '8px';
      constDiv.style.backgroundColor = 'var(--bg-secondary)';
      constDiv.style.borderRadius = '4px';

      constDiv.innerHTML = `
        <code style="color: var(--accent-color);">${c.name} = ${c.value}</code>
        <span style="color: var(--text-secondary); margin-left: 12px; font-size: 12px;">- ${c.description}</span>
      `;

      constantsDiv.appendChild(constDiv);
    });

    container.appendChild(constantsDiv);
  }

  if (container.children.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 20px;">SonuÃ§ bulunamadÄ±.</p>';
  }
}

function handleDocumentation() {
  const message = `
ğŸ“š MLP GUI Designer DokÃ¼mantasyonu

Dosya Konumu:
  mlp_gui_designer/README.md
  mlp_gui_designer/QUICKSTART.md
  mlp_gui_designer/ARCHITECTURE.md

Online DokÃ¼mantasyon:
  https://github.com/your-repo/MLP

Ä°Ã§erik:
  â€¢ Widget tÃ¼rleri ve Ã¶zellikleri
  â€¢ Kod Ã¼retimi
  â€¢ Proje yÃ¶netimi
  â€¢ Ä°leri seviye Ã¶zellikler

DokÃ¼mantasyon dosyalarÄ±nÄ± bir metin editÃ¶rÃ¼
veya markdown viewer ile aÃ§abilirsiniz.
  `;
  alert(message);
}

function handleMlpDocs() {
  const message = `
ğŸ“– MLP Dili DokÃ¼mantasyonu

Dosya Konumu:
  ../README.md
  ../SPECS.md
  ../docs/

MLP Dili Ã–zellikleri:
  â€¢ Ã‡ok dilli syntax (TR, EN, RU, ZH, HI)
  â€¢ Self-hosting compiler
  â€¢ x86-64 assembly output
  â€¢ Struct, enum, list desteÄŸi
  â€¢ GUI runtime

Ã–rnekler:
  ../examples/
  ../tests/

MLP derleyicisi ile ilgili detaylÄ± bilgi
iÃ§in ana README dosyasÄ±na bakÄ±n.
  `;
  alert(message);
}

function handleAbout() {
  const message = `
ğŸ¨ MLP GUI Designer
Versiyon 1.0.3 âš¡ GPU-Accelerated

Visual Studio tarzÄ±nda profesyonel
GUI tasarÄ±m aracÄ± - MLP Dili iÃ§in

Ã–zellikler:
  âœ… 9 widget tÃ¼rÃ¼
  âœ… SÃ¼rÃ¼kle-bÄ±rak interface (Figma-level smooth!)
  âœ… CanlÄ± Ã¶zellik editÃ¶rÃ¼
  âœ… Otomatik kod Ã¼retimi
  âœ… Proje yÃ¶netimi
  âœ… Light/Dark theme
  âœ… GPU-accelerated drag (60 FPS)

Teknoloji:
  â€¢ Electron 28+
  â€¢ Vanilla JavaScript
  â€¢ Pure CSS
  â€¢ GPU Compositing (transform3d)

Performans:
  â€¢ 60 FPS drag & drop
  â€¢ <16ms input lag
  â€¢ Layout Reflow eliminated

GeliÅŸtirici: MLP Team
Lisans: MIT
Tarih: 23 KasÄ±m 2024

MLP programlama dili hakkÄ±nda:
  https://github.com/your-repo/MLP
  `;
  alert(message);
};
