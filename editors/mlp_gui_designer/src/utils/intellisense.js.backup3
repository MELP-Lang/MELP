// IntelliSense Autocomplete System

class IntelliSense {
  constructor() {
    this.popup = null;
    this.items = [];
    this.selectedIndex = 0;
    this.isVisible = false;
    this.currentEditor = null;
    this.triggerPosition = { line: 0, column: 0 };
    this.filterText = '';

    // MLP functions database
    this.functions = [];
    this.keywords = [];

    this.createPopup();
    this.loadFunctions();
  }

  // Popup HTML oluÅŸtur
  createPopup() {
    this.popup = document.createElement('div');
    this.popup.className = 'intellisense-popup';
    this.popup.style.display = 'none';
    document.body.appendChild(this.popup);
  }

  // MLP fonksiyonlarÄ±nÄ± yÃ¼kle
  async loadFunctions() {
    try {
      const response = await fetch('./mlp_functions.json');
      const data = await response.json();

      // FonksiyonlarÄ± dÃ¼zleÅŸtir
      this.functions = [];
      for (const category of Object.values(data.categories)) {
        this.functions.push(...category.functions);
      }

      // Sabitleri ekle
      if (data.constants) {
        this.functions.push(...data.constants.map(c => ({
          name: c.name,
          signature: `${c.name} = ${c.value}`,
          description: c.description,
          category: 'constant'
        })));
      }

      console.log(`IntelliSense: ${this.functions.length} fonksiyon yÃ¼klendi`);
    } catch (error) {
      console.error('IntelliSense functions loading error:', error);
    }
  }

  // MLP keyword'lerini yÃ¼kle
  loadKeywords(keywords) {
    this.keywords = keywords.map(kw => ({
      name: kw,
      signature: kw,
      description: 'MLP anahtar kelimesi',
      category: 'keyword'
    }));
  }

  // IntelliSense'i gÃ¶ster
  show(editor, position) {
    console.log("IntelliSense.show() called", { line: position?.line, column: position?.column });
    this.currentEditor = editor;
    this.triggerPosition = position;

    // Filtreleme iÃ§in metin al
    const line = this.getLineText(position.line);
    this.filterText = this.getWordBeforeCursor(line, position.column);

    // Ã–nerileri filtrele
    this.updateSuggestions();

    if (this.items.length === 0) {
      this.hide();
      return;
    }

    // Popup'Ä± konumlandÄ±r
    this.positionPopup(position);

    // GÃ¶ster
    console.log("IntelliSense: Showing popup with", this.items.length, "items");
    this.popup.style.display = 'block';
    this.isVisible = true;
    this.selectedIndex = 0;
    this.renderItems();
  }

  // Ã–nerileri gÃ¼ncelle
  updateSuggestions() {
    const filter = this.filterText.toLowerCase();

    // TÃ¼m Ã¶ÄŸeleri birleÅŸtir
    const allItems = [...this.functions, ...this.keywords];

    // Filtrele
    if (filter.length === 0) {
      this.items = allItems.slice(0, 20); // Ä°lk 20'yi gÃ¶ster
    } else {
      this.items = allItems.filter(item =>
        item.name.toLowerCase().startsWith(filter)
      ).slice(0, 20);
    }

    // Ä°sme gÃ¶re sÄ±rala
    this.items.sort((a, b) => a.name.localeCompare(b.name));
  }

  // Popup konumlandÄ±r
  positionPopup(position) {
    const selection = window.getSelection();
    if (!selection.rangeCount) {
      console.warn('IntelliSense: No selection range');
      return;
    }

    const range = selection.getRangeAt(0);
    const rect = range.getBoundingClientRect();

    // EÄŸer rect boÅŸsa (cursor gÃ¶rÃ¼nmÃ¼yorsa), editor'Ã¼n koordinatlarÄ±nÄ± kullan
    if (rect.width === 0 && rect.height === 0) {
      const editorRect = this.currentEditor.getBoundingClientRect();
      this.popup.style.left = `${editorRect.left + 10}px`;
      this.popup.style.top = `${editorRect.top + 30}px`;
      console.log('IntelliSense: Using fallback position');
      return;
    }

    // Cursor'un gerÃ§ek pozisyonunu kullan
    const left = rect.left;
    const top = rect.bottom + 2;

    this.popup.style.left = `${left}px`;
    this.popup.style.top = `${top}px`;
    
    console.log('IntelliSense popup positioned at:', { left, top, items: this.items.length });
  }
  // Ã–ÄŸeleri render et
  renderItems() {
    this.popup.innerHTML = '';

    this.items.forEach((item, index) => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'intellisense-item';
      if (index === this.selectedIndex) {
        itemDiv.classList.add('selected');
      }

      // Icon
      const icon = this.getIconForCategory(item.category);
      const iconSpan = document.createElement('span');
      iconSpan.className = 'intellisense-icon';
      iconSpan.textContent = icon;

      // Name
      const nameSpan = document.createElement('span');
      nameSpan.className = 'intellisense-name';
      nameSpan.textContent = item.name;

      // Type/Category
      const typeSpan = document.createElement('span');
      typeSpan.className = 'intellisense-type';
      typeSpan.textContent = item.category || 'function';

      itemDiv.appendChild(iconSpan);
      itemDiv.appendChild(nameSpan);
      itemDiv.appendChild(typeSpan);

      // Click event
      itemDiv.addEventListener('click', () => {
        this.selectItem(index);
      });

      // Hover event
      itemDiv.addEventListener('mouseenter', () => {
        this.selectedIndex = index;
        this.renderItems();
      });

      this.popup.appendChild(itemDiv);
    });
  }

  // Kategori icon'u
  getIconForCategory(category) {
    const icons = {
      'function': 'ğ‘“',
      'keyword': 'ğŸ”‘',
      'constant': 'ğŸ“Œ',
      'variable': 'ğŸ“¦',
      'reduce': 'âˆ‘',
      'map': 'â†’',
      'utility': 'ğŸ”§'
    };
    return icons[category] || 'ğŸ“„';
  }

  // Ã–ÄŸe seÃ§ ve ekle
  selectItem(index) {
    if (index < 0 || index >= this.items.length) return;

    const item = this.items[index];
    this.insertCompletion(item);
    this.hide();
  }

  // TamamlamayÄ± ekle
  insertCompletion(item) {
    // Basit implementasyon - sadece fonksiyon adÄ±nÄ± ekle
    const completion = item.name;

    // Editor'e yazdÄ±rma iÅŸlemi
    // Not: Bu kÄ±sÄ±m editor implementasyonuna baÄŸlÄ±
    if (this.currentEditor && this.currentEditor.textContent !== undefined) {
      const lines = this.currentEditor.textContent.split('\n');
      const line = lines[this.triggerPosition.line] || '';

      // Kelimeyi deÄŸiÅŸtir
      const before = line.substring(0, this.triggerPosition.column - this.filterText.length);
      const after = line.substring(this.triggerPosition.column);

      lines[this.triggerPosition.line] = before + completion + after;
      this.currentEditor.textContent = lines.join('\n');

      // Event tetikle (kod gÃ¼ncelleme iÃ§in)
      this.currentEditor.dispatchEvent(new Event('input', { bubbles: true }));
    }
  }

  // Gizle
  hide() {
    this.popup.style.display = 'none';
    this.isVisible = false;
    this.items = [];
    this.selectedIndex = 0;
  }

  // YukarÄ± ok
  selectPrevious() {
    if (this.selectedIndex > 0) {
      this.selectedIndex--;
      this.renderItems();
      this.scrollToSelected();
    }
  }

  // AÅŸaÄŸÄ± ok
  selectNext() {
    if (this.selectedIndex < this.items.length - 1) {
      this.selectedIndex++;
      this.renderItems();
      this.scrollToSelected();
    }
  }

  // SeÃ§ili Ã¶ÄŸeye scroll
  scrollToSelected() {
    const items = this.popup.querySelectorAll('.intellisense-item');
    if (items[this.selectedIndex]) {
      items[this.selectedIndex].scrollIntoView({ block: 'nearest' });
    }
  }

  // Enter - seÃ§ili Ã¶ÄŸeyi ekle
  insertSelected() {
    if (this.items.length > 0) {
      this.selectItem(this.selectedIndex);
    }
  }

  // Escape - gizle
  cancel() {
    this.hide();
  }

  // YardÄ±mcÄ±: SatÄ±r metnini al
  getLineText(lineNum) {
    if (!this.currentEditor) return '';
    console.log("[getLineText] currentEditor:", this.currentEditor);
    
    // innerText kullan (contenteditable iÃ§in daha gÃ¼venilir)
    const text = this.currentEditor.innerText || this.currentEditor.textContent;
    const lines = text.split('\n');
    
    console.log("[getLineText] total lines:", lines.length, "lineNum:", lineNum);
    console.log("[getLineText] line content:", lines[lineNum] || '(empty)');
    
    return lines[lineNum] || '';
  }
  }

  // YardÄ±mcÄ±: Cursor'dan Ã¶nceki kelimeyi al
  getWordBeforeCursor(line, column) {
    const textBefore = line.substring(0, column);
    const match = textBefore.match(/[a-zA-Z_][a-zA-Z0-9_]*$/);
    return match ? match[0] : '';
  }

  // YardÄ±mcÄ±: Cursor pozisyonunu al (editor iÃ§inde)
  getCursorPosition(editor) {
    const selection = window.getSelection();
    if (!selection.rangeCount) {
      console.warn('IntelliSense: No selection for cursor position');
      return { line: 0, column: 0 };
    }

    const range = selection.getRangeAt(0);
    const preCaretRange = range.cloneRange();
    preCaretRange.selectNodeContents(editor);
    preCaretRange.setEnd(range.endContainer, range.endOffset);
    const textBefore = preCaretRange.toString();
    const lines = textBefore.split('\n');

    const pos = {
      line: lines.length - 1,
      column: lines[lines.length - 1].length
    };
    
    console.log('IntelliSense cursor position:', pos);
    return pos;
  }
}

// Global instance
const intelliSense = new IntelliSense();
