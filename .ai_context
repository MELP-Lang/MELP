# .ai_context - AI Assistant Context File
**Last Updated:** 7 AralÄ±k 2025

âš ï¸ **READ THIS BEFORE ANY CODE CHANGE!** âš ï¸

---

## ğŸ”’ IMMUTABLE ARCHITECTURE RULES

### Rule 1: File Size Limits
- **main.c:** MAX 300 lines (STRICTLY ENFORCED)
- **Module files:** MAX 500 lines each
- **Pipeline files:** MAX 800 lines (orchestration exception)

### Rule 2: Binary Naming
- **Correct:** `melpc` (version-agnostic)
- **FORBIDDEN:** `melpc_26`, `melpc_v1`, any versioned name

### Rule 3: Modular Architecture
- Each concern = separate module
- No merging modules into main.c
- No central orchestration >800 lines
- Clear separation of responsibilities

### Rule 4: Module Structure
- 26 modules in `modules/` directory
- Each module: `module.c`, `module.h`, `module_parser.c`, `module_codegen.c`
- Exceptions documented in ARCHITECTURE.md

---

## ğŸ“Š CURRENT STATUS (7 AralÄ±k 2025)

### âœ… Architecture Clean!

```
main.c:               32 lines  âœ… (89% under limit)
error_handler.c:      38 lines  âœ…
cli_parser.c:         44 lines  âœ…
pipeline.c:          710 lines  âœ… (orchestration exception)
Binary name:         melpc      âœ…
Modules:             26 active  âœ…
Validation:          PASSING    âœ…
```

### Recent Refactoring (7 Dec 2025)
- âœ… Split monolithic 744-line main.c into modular structure
- âœ… Created error/, cli/, pipeline/ modules
- âœ… Removed versioned binary (melpc_26)
- âœ… All tests passing
- âœ… Architecture validation passing

---

## ğŸš« FORBIDDEN ACTIONS

### âŒ NEVER DO THIS:
1. **Merge modules into main.c** - Destroys modular architecture
2. **Create files >500 lines** (except pipeline.c orchestration)
3. **Rename binary** to melpc_XX or any versioned name
4. **Bypass architecture validation** - Validation is mandatory
5. **Skip ARCHITECTURE.md** - Rules are immutable
6. **Disable pre-commit hooks** - Safety net required

### âš ï¸ If Rule Violation Seems Necessary:
```
STOP! Don't proceed automatically.

Ask user:
"âš ï¸ This action violates ARCHITECTURE.md Rule X:
[Explain which rule and why it's violated]

Violation needed because: [Explain technical reason]

User confirmation required to proceed.
Continue? (yes/no)"
```

---

## âœ… BEFORE ANY CODE CHANGE

### Pre-Change Checklist:
1. âœ… Read ARCHITECTURE.md
2. âœ… Check current line counts: `wc -l compiler/stage0/main.c`
3. âœ… Verify change doesn't violate rules
4. âœ… Plan modular approach (split if needed)
5. âœ… Run validation after change: `bash scripts/validate_architecture.sh`

### After Every Change:
```bash
# Validate architecture
cd /home/pardus/projeler/MLP/MLP
bash ./scripts/validate_architecture.sh

# If validation fails â†’ STOP and fix!
```

---

## ğŸ—ï¸ MODULE RESPONSIBILITIES

### Current Modular Structure:

```
compiler/stage0/
â”œâ”€â”€ main.c (32 lines)
â”‚   â””â”€â”€ Entry point: CLI â†’ Pipeline â†’ Exit
â”‚
â”œâ”€â”€ error/
â”‚   â””â”€â”€ Error reporting & syntax error messages
â”‚
â”œâ”€â”€ cli/
â”‚   â””â”€â”€ Command-line argument parsing, help, version
â”‚
â”œâ”€â”€ pipeline/
â”‚   â””â”€â”€ Compilation orchestration (lexer, parser, codegen)
â”‚
â””â”€â”€ modules/ (26 modules)
    â”œâ”€â”€ arithmetic/
    â”œâ”€â”€ comparison/
    â”œâ”€â”€ logical/
    â”œâ”€â”€ variable/
    â””â”€â”€ ... (22 more)
```

---

## ğŸ¯ CURRENT PHASE

**Phase:** Post-Refactoring (Ready for Phase 3.5)

**Status:** âœ… Architecture Clean

**Next Steps:**
- Phase 3.5: Expressions & Operators
- TTO runtime integration for complex expressions
- Expression codegen improvements

**IMPORTANT:** Maintain modular architecture during Phase 3.5!
- Don't inflate main.c
- Add expression logic to modules/arithmetic/
- Keep pipeline.c focused on orchestration

---

## ğŸ“‹ VALIDATION COMMANDS

```bash
# Full architecture validation
bash ./scripts/validate_architecture.sh

# Quick line count check
wc -l compiler/stage0/main.c
wc -l compiler/stage0/pipeline/pipeline.c

# Build with validation
cd compiler/stage0 && make clean && make all

# Test compilation
cd compiler/stage0
./melpc demo_melp.mlp test.s
nasm -f elf64 test.s -o test.o
ld test.o -o test
./test
```

---

## ğŸ›¡ï¸ PROTECTION LAYERS ACTIVE

1. âœ… **AI Context File** (this file) - Read before every change
2. âœ… **ARCHITECTURE.md** - Immutable rules documentation
3. âœ… **Validation Script** - `scripts/validate_architecture.sh`
4. â³ **Makefile Guard** - Build-time validation (being added)
5. âœ… **Git Pre-commit Hook** - Commit-time validation

---

## ğŸ“š QUICK REFERENCE

### Key Files:
- `ARCHITECTURE.md` - Architecture rules
- `scripts/validate_architecture.sh` - Validation script
- `.git/hooks/pre-commit` - Pre-commit validation
- `compiler/stage0/Makefile` - Build configuration

### Key Limits:
- main.c: 300 lines MAX
- Module files: 500 lines MAX
- Pipeline: 800 lines MAX (exception)

### Key Commands:
```bash
# Validate
bash ./scripts/validate_architecture.sh

# Build
cd compiler/stage0 && make

# Test
./melpc --version
./melpc input.mlp output.s
```

---

## ğŸ†˜ TROUBLESHOOTING

### "main.c exceeds 300 lines"
â†’ Split logic into error/, cli/, or pipeline/ modules
â†’ Create new module in modules/ if needed
â†’ NEVER inflate main.c!

### "Versioned binary detected"
â†’ Use `melpc` only, never `melpc_XX`
â†’ Check Makefile TARGET variable

### "Architecture validation fails"
â†’ Read validation output carefully
â†’ Fix violations before proceeding
â†’ Re-run validation after fix

---

**REMEMBER:** Architecture is SACRED! ğŸ›¡ï¸

When in doubt â†’ ASK USER before violating rules!
