# YZ_91: Phase 22 - String Interpolation Implementation

**Session:** YZ_91  
**Date:** 15 AralÄ±k 2025  
**Agent:** GitHub Copilot (Claude Opus 4.5)  
**Branch:** `phase18-array-support_YZ_74`

---

## ğŸ‰ Session Summary

**Achievement:** Complete string interpolation with automatic numeric-to-string conversion!

This session implemented Phase 22 - String Interpolation:
- `"Hello ${name}"` - String variable interpolation
- `"Age: ${age}"` - Numeric variable interpolation (auto-converted)
- `"x=${x}, y=${y}"` - Multiple interpolations in single string

---

## ğŸ“‹ Implementation Details

### 1. Problem Analysis

The string interpolation parser already existed (`string_interpolation.c`) but had issues:
- Variables were not type-checked at codegen time
- Numeric variables caused segfaults when passed to `mlp_string_concat`
- `println` always used `sto_print_int64` even for strings

### 2. Solution: Symbol Table Type Lookup

Added helper function to check variable types from symbol table:

```c
// YZ_91: Helper to check if a variable is a string type
static int is_var_string_type(const char* var_name, FunctionDeclaration* func) {
    // Check local variables
    LocalVariable* var = func->local_vars;
    while (var) {
        if (strcmp(var->name, var_name) == 0) {
            return !var->is_numeric;  // is_numeric=0 means string
        }
        var = var->next;
    }
    // Check parameters
    FunctionParam* param = func->params;
    while (param) {
        if (strcmp(param->name, var_name) == 0) {
            return (param->type == FUNC_PARAM_TEXT);
        }
        param = param->next;
    }
    return 0;  // Default to numeric
}
```

### 3. STO-Compliant Register Usage

**Critical Fix:** x86-64 System V ABI compliance for function calls.

**Problem:** Caller-saved registers (`r8-r11`) get clobbered by function calls.

**Solution:** Use callee-saved registers (`r12-r13`) for string concatenation:

```asm
# Before numeric conversion
pushq %r12              # Save callee-saved
pushq %r13              # Save callee-saved
movq %r8, %r12          # Left operand to callee-saved
movq %r9, %r13          # Right operand to callee-saved

# Convert numeric to string (r12/r13 preserved!)
movq %r13, %rdi
call mlp_number_to_string
movq %rax, %r13

# Concatenate (values still in r12/r13)
movq %r12, %rdi
movq %r13, %rsi
call mlp_string_concat

# Restore
popq %r13
popq %r12
```

### 4. println String Detection

Updated `println` codegen to detect string expressions:

```c
// Check if argument is string type
int is_string_arg = arg->is_string;

// Check variable type from symbol table
if (!is_string_arg && !arg->is_literal && arg->value) {
    is_string_arg = is_var_string_type(arg->value, func);
}

if (is_string_arg) {
    fprintf(output, "    call puts  # Print string + newline\n");
} else {
    fprintf(output, "    call sto_print_int64\n");
    fprintf(output, "    call putchar\n");  // newline
}
```

---

## ğŸ“ Files Modified

| File | Changes |
|------|---------|
| `arithmetic/arithmetic_codegen.c` | Added `is_var_string_type()`, updated println codegen, added numeric-to-string conversion with callee-saved registers |
| `print/print_codegen.c` | Added `is_variable_string()`, `is_expression_string()`, updated print to use `puts` for strings |

---

## ğŸ§ª Test Results

| Test File | Expected Output | Result |
|-----------|-----------------|--------|
| `test_string_interp_simple.mlp` | `Hello Dunya!` | âœ… |
| `test_string_interp_basic.mlp` | `Merhaba Ali, yaÅŸÄ±nÄ±z 25` | âœ… |
| `test_string_interp_multi.mlp` | `Merhaba Ahmet! x=10, y=20, toplam=30` | âœ… |

### Regression Tests (from YZ_90)

| Test | Expected Exit | Result |
|------|---------------|--------|
| `test_continue_simple.mlp` | 15 | âœ… |
| `test_exit_for.mlp` | 15 | âœ… |
| `test_for_downto.mlp` | 55 | âœ… |
| `test_exit_while.mlp` | 10 | âœ… |
| `test_continue_while.mlp` | 45 | âœ… |

---

## ğŸ“ Syntax Reference

### String Interpolation
```pmpl
string name = "Ali"
numeric age = 25
numeric x = 10
numeric y = 20

# String variable interpolation
string greeting = "Hello ${name}!"

# Numeric variable interpolation (auto-converted)
string info = "Age: ${age}"

# Multiple interpolations
string result = "x=${x}, y=${y}, sum=${x + y}"  # Future: expressions

# Print interpolated string
println(greeting)
println(info)
```

---

## âš ï¸ Known Limitations

1. **Expression Interpolation:** Currently only variables supported, not expressions
   - Works: `"x=${x}"`
   - Future: `"sum=${x + y}"` (requires expression parsing in interpolation)

2. **Float Support:** Only integer conversion implemented
   - `mlp_number_to_string()` uses `%lld` format
   - Future: Add `mlp_float_to_string()` for double values

3. **Memory Management:** Concatenated strings not freed
   - Each `mlp_string_concat` allocates new memory
   - Future: Add garbage collection or RAII

---

## ğŸ”§ Technical Notes

### x86-64 System V ABI Register Classification

| Category | Registers | Behavior |
|----------|-----------|----------|
| Caller-saved | rax, rcx, rdx, rsi, rdi, r8-r11 | Clobbered by function calls |
| Callee-saved | rbx, rbp, r12-r15 | Preserved across function calls |

### Why Callee-Saved for String Concat?

```
Problem:
  r8 = "Hello "
  r9 = 25 (numeric)
  call mlp_number_to_string  # r8 CLOBBERED!
  call mlp_string_concat     # r8 now garbage!

Solution:
  r12 = "Hello "  (preserved)
  r13 = 25
  call mlp_number_to_string  # r12 PRESERVED!
  call mlp_string_concat     # r12 still valid!
```

---

## ğŸš€ Next Steps

Suggested features for YZ_92:
- **Option A:** Expression interpolation (`"sum=${x+y}"`)
- **Option B:** Enum Types
- **Option C:** Float-to-string conversion
- **Option D:** Documentation & cleanup

---

## ğŸ“Š Session Statistics

- **Duration:** ~2 hours
- **Files Modified:** 2
- **New Tests:** 3
- **Bugs Fixed:** 3 (println string detection, numeric conversion, register clobbering)
- **Lines Added:** ~100
- **Complexity:** Medium-High (ABI compliance)

---

**End of YZ_91 Report**
