# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  MELP Stage 0 - MODULAR ARCHITECTURE ONLY                 â•‘
# â•‘  NO monolithic compiler (main.c/pipeline.c FORBIDDEN)     â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: all clean help test-functions test-string modules
.DEFAULT_GOAL := help

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Architecture Enforcement
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

check-monolithic:
	@echo "ğŸ” Checking for monolithic violations..."
	@if [ -f main.c ] || [ -f pipeline/pipeline.c ] || [ -f cli/cli_parser.c ] || [ -f melpc ]; then \
		echo ""; \
		echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"; \
		echo "â•‘   âŒ ARCHITECTURE VIOLATION!               â•‘"; \
		echo "â•‘   Monolithic files detected:               â•‘"; \
		[ -f main.c ] && echo "â•‘     - main.c                               â•‘" || true; \
		[ -d cli ] && echo "â•‘     - cli/                                 â•‘" || true; \
		[ -d pipeline ] && echo "â•‘     - pipeline/                            â•‘" || true; \
		[ -f melpc ] && echo "â•‘     - melpc binary                         â•‘" || true; \
		echo "â•‘                                            â•‘"; \
		echo "â•‘   âš ï¸  FORBIDDEN: Use modular compilers     â•‘"; \
		echo "â•‘   âœ… Allowed: modules/*/standalone         â•‘"; \
		echo "â•‘                                            â•‘"; \
		echo "â•‘   Read: RADICAL_CHANGE.md                  â•‘"; \
		echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		echo ""; \
		exit 1; \
	else \
		echo "âœ… No monolithic files - Architecture clean!"; \
	fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Build Targets
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

all: check-monolithic modules
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  âœ… MELP Stage 0 - Modular Build Complete  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Available compilers:"
	@echo "  â€¢ modules/functions/functions_compiler"
	@echo "  â€¢ modules/functions/functions_standalone"
	@echo ""

modules: check-monolithic
	@echo "Building modular compilers..."
	@$(MAKE) -C modules/functions

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Runtime Libraries
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

runtime:
	@echo "Building runtime libraries..."
	@$(MAKE) -C ../../runtime/tto
	@$(MAKE) -C ../../runtime/stdlib

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Testing
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

test-functions: modules
	@echo "Testing functions compiler..."
	@cd modules/functions && ./functions_compiler test_mvc.mlp test_mvc.s
	@cd modules/functions && gcc -no-pie test_mvc.s \
		-L../../../../runtime/stdlib -lmlp_stdlib \
		-L../../../../runtime/tto -ltto_runtime -lm \
		-o test_mvc
	@cd modules/functions && ./test_mvc
	@echo "âœ… Functions test passed!"

test-string: modules
	@echo "Testing string operations..."
	@cd modules/functions && ./functions_compiler test_string_concat.mlp test_string_concat.s
	@cd modules/functions && gcc -no-pie test_string_concat.s \
		-L../../../../runtime/stdlib -lmlp_stdlib \
		-L../../../../runtime/tto -ltto_runtime -lm \
		-o test_string_concat
	@cd modules/functions && ./test_string_concat
	@echo "âœ… String concatenation test passed!"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Cleanup
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

clean: check-monolithic
	@echo "Cleaning modular builds..."
	@$(MAKE) -C modules/functions clean || true
	@find . -name "*.o" -delete
	@find . -name "*.s" -delete
	@find . -name "test_*" -type f -executable -delete
	@echo "âœ… Clean complete"

clean-all: clean
	@echo "Cleaning runtime libraries..."
	@$(MAKE) -C ../../runtime/tto clean || true
	@$(MAKE) -C ../../runtime/stdlib clean || true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Help
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

help:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  MELP Stage 0 - Modular Architecture Build System      â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "âš ï¸  NO MONOLITHIC COMPILER!"
	@echo "   main.c, pipeline.c, cli/, melpc are FORBIDDEN"
	@echo ""
	@echo "Available targets:"
	@echo "  make all              Build all modular compilers"
	@echo "  make modules          Build function compiler modules"
	@echo "  make runtime          Build TTO + stdlib libraries"
	@echo "  make test-functions   Test functions compiler (MVC)"
	@echo "  make test-string      Test string operations"
	@echo "  make clean            Clean build artifacts"
	@echo "  make clean-all        Clean everything including runtime"
	@echo ""
	@echo "Modular compilers location:"
	@echo "  ğŸ“ modules/functions/functions_compiler"
	@echo ""
	@echo "Usage example:"
	@echo "  cd modules/functions"
	@echo "  ./functions_compiler input.mlp output.s"
	@echo "  gcc output.s -L../../runtime/... -o program"
	@echo ""
	@echo "ğŸ“– Read: RADICAL_CHANGE.md, ARCHITECTURE.md"
	@echo ""
