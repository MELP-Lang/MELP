# Functions Module - Standalone Test Compiler Makefile
# Mod√ºl #7 (P0 Critical)
#
# Baƒüƒ±mlƒ±lƒ±klar:
#   - variable (mod√ºl #1)
#   - comments (mod√ºl #2)
#   - arithmetic (mod√ºl #3)
#   - comparison (mod√ºl #4)
#   - logical (mod√ºl #5)
#   - control_flow (mod√ºl #6)

CC = gcc
CFLAGS = -Wall -Wextra -g -I../.. -I../../../../runtime/sto -I../../../../runtime/stdlib
LDFLAGS = -L../../../../runtime/stdlib -lmlp_stdlib -L../../../../runtime/sto -lsto_runtime -lm
NASM = nasm
NASMFLAGS = -f elf64
LD = ld

# Ana hedef
TARGET = functions_compiler

# Ana kaynak dosyalar
MAIN_SRC = functions_standalone.c

# Functions mod√ºl√º kaynaklarƒ±
FUNCTIONS_SOURCES = \
	functions.c \
	functions_parser.c \
	functions_codegen.c \
	functions_codegen_llvm.c

# Variable mod√ºl√º (Mod√ºl #1)
VARIABLE_DIR = ../variable
VARIABLE_SOURCES = \
	$(VARIABLE_DIR)/variable.c \
	$(VARIABLE_DIR)/variable_parser.c \
	$(VARIABLE_DIR)/variable_codegen.c

# Comments mod√ºl√º (Mod√ºl #2)
COMMENTS_DIR = ../comments
COMMENTS_SOURCES = \
	$(COMMENTS_DIR)/comments.c \
	$(COMMENTS_DIR)/comments_parser.c

# Arithmetic mod√ºl√º (Mod√ºl #3)
ARITHMETIC_DIR = ../arithmetic
ARITHMETIC_SOURCES = \
	$(ARITHMETIC_DIR)/arithmetic.c \
	$(ARITHMETIC_DIR)/arithmetic_parser.c \
	$(ARITHMETIC_DIR)/arithmetic_codegen.c \
	$(ARITHMETIC_DIR)/arithmetic_optimize.c

# Comparison mod√ºl√º (Mod√ºl #4)
COMPARISON_DIR = ../comparison
COMPARISON_SOURCES = \
	$(COMPARISON_DIR)/comparison.c \
	$(COMPARISON_DIR)/comparison_parser.c \
	$(COMPARISON_DIR)/comparison_codegen.c

# Logical mod√ºl√º (Mod√ºl #5)
LOGICAL_DIR = ../logical
LOGICAL_SOURCES = \
	$(LOGICAL_DIR)/logical.c \
	$(LOGICAL_DIR)/logical_parser.c \
	$(LOGICAL_DIR)/logical_codegen.c

# Control Flow mod√ºl√º (Mod√ºl #6)
CONTROL_FLOW_DIR = ../control_flow
CONTROL_FLOW_SOURCES = \
	$(CONTROL_FLOW_DIR)/control_flow.c \
	$(CONTROL_FLOW_DIR)/control_flow_parser.c \
	$(CONTROL_FLOW_DIR)/control_flow_codegen.c

# For Loop mod√ºl√º (Mod√ºl #7 - Phase 3.3)
FOR_LOOP_DIR = ../for_loop
FOR_LOOP_SOURCES = \
	$(FOR_LOOP_DIR)/for_loop.c \
	$(FOR_LOOP_DIR)/for_loop_parser.c \
	$(FOR_LOOP_DIR)/for_loop_codegen.c

# Print mod√ºl√º (YZ_61 - Phase 15)
PRINT_DIR = ../print
PRINT_SOURCES = \
	$(PRINT_DIR)/print.c \
	$(PRINT_DIR)/print_parser.c \
	$(PRINT_DIR)/print_codegen.c

# Array mod√ºl√º (YZ_14 - Array indexing)
ARRAY_DIR = ../array
ARRAY_SOURCES = \
	$(ARRAY_DIR)/array_parser.c \
	$(ARRAY_DIR)/array_codegen.c

# Statement mod√ºl√º (Body parsing i√ßin)
STATEMENT_DIR = ../statement
STATEMENT_SOURCES = \
	$(STATEMENT_DIR)/statement.c \
	$(STATEMENT_DIR)/statement_parser.c \
	$(STATEMENT_DIR)/statement_codegen.c \
	$(STATEMENT_DIR)/statement_optimize.c

# Import mod√ºl√º (YZ_35 - Module system)
IMPORT_DIR = ../import
IMPORT_SOURCES = \
	$(IMPORT_DIR)/import.c \
	$(IMPORT_DIR)/import_parser.c \
	$(IMPORT_DIR)/import_cache.c \
	$(IMPORT_DIR)/import_cache_persist.c

# Parser Core mod√ºl√º (Parser structure)
PARSER_CORE_DIR = ../parser_core
PARSER_CORE_SOURCES = \
	$(PARSER_CORE_DIR)/parser_core.c

# Lexer (merkezi)
LEXER_SOURCES = ../lexer/lexer.c

# Codegen Context (TTO desteƒüi i√ßin)
CODEGEN_CONTEXT_DIR = ../codegen_context
CODEGEN_CONTEXT_SOURCES = $(CODEGEN_CONTEXT_DIR)/codegen_context.c

# Error Handling mod√ºl√º
ERROR_DIR = ../error
ERROR_SOURCES = $(ERROR_DIR)/error.c

# LLVM Backend mod√ºl√º (YZ_58)
LLVM_BACKEND_DIR = ../llvm_backend
LLVM_BACKEND_SOURCES = $(LLVM_BACKEND_DIR)/llvm_backend.c

# T√ºm kaynak dosyalar
SOURCES = \
	$(MAIN_SRC) \
	$(FUNCTIONS_SOURCES) \
	$(VARIABLE_SOURCES) \
	$(COMMENTS_SOURCES) \
	$(ARITHMETIC_SOURCES) \
	$(COMPARISON_SOURCES) \
	$(LOGICAL_SOURCES) \
	$(CONTROL_FLOW_SOURCES) \
	$(FOR_LOOP_SOURCES) \
	$(PRINT_SOURCES) \
	$(ARRAY_SOURCES) \
	$(STATEMENT_SOURCES) \
	$(IMPORT_SOURCES) \
	$(PARSER_CORE_SOURCES) \
	$(CODEGEN_CONTEXT_SOURCES) \
	$(ERROR_SOURCES) \
	$(LLVM_BACKEND_SOURCES) \
	$(LEXER_SOURCES)

# Object dosyalarƒ±
OBJECTS = $(SOURCES:.c=.o)

# Test dosyalarƒ±
TEST_SOURCE = test_func.mlp
TEST_ASM = test_func.s
TEST_OBJ = test_func.o
TEST_EXEC = test_func

# Varsayƒ±lan hedef
all: info $(TARGET)
	@echo ""
	@echo "‚úÖ Functions Standalone Compiler hazƒ±r!"
	@echo "   Binary: $(TARGET)"
	@echo "   Boyut: $$(du -h $(TARGET) | cut -f1)"
	@echo ""
	@echo "Test i√ßin: make test"

# Bilgilendirme
info:
	@echo "=========================================="
	@echo "  FUNCTIONS MODULE BUILD"
	@echo "  Mod√ºl #7 (P0 Critical)"
	@echo "=========================================="
	@echo "Baƒüƒ±mlƒ±lƒ±klar:"
	@echo "  ‚Ä¢ variable (Mod√ºl #1)"
	@echo "  ‚Ä¢ comments (Mod√ºl #2)"
	@echo "  ‚Ä¢ arithmetic (Mod√ºl #3)"
	@echo "  ‚Ä¢ comparison (Mod√ºl #4)"
	@echo "  ‚Ä¢ logical (Mod√ºl #5)"
	@echo "  ‚Ä¢ control_flow (Mod√ºl #6)"
	@echo ""
	@echo "Toplam kaynak dosya sayƒ±sƒ±: $$(echo $(SOURCES) | wc -w)"
	@echo ""

# Ana derleyici
$(TARGET): $(OBJECTS) ../../../../runtime/sto/libsto_runtime.a ../../../../runtime/stdlib/libmlp_stdlib.a
	@echo "üîó Linking: $(TARGET)"
	$(CC) $(CFLAGS) -o $@ $(OBJECTS) $(LDFLAGS)

# Standalone executable (simplified build)
functions_standalone: functions_standalone.o $(filter-out functions_standalone.o,$(OBJECTS))
	@echo "üîó Linking: functions_standalone"
	$(CC) $(CFLAGS) -o $@ $^

# C dosyalarƒ±nƒ± derle
%.o: %.c
	@echo "  üì¶ Compiling: $<"
	$(CC) $(CFLAGS) -c $< -o $@

# Test hedefi
test: $(TARGET)
	@echo ""
	@echo "=========================================="
	@echo "  FUNCTIONS MODULE TEST"
	@echo "=========================================="
	@echo ""
	@echo "üìù Test dosyasƒ± olu≈üturuluyor..."
	@echo 'sayisal x = 10' > $(TEST_SOURCE)
	@echo 'sayisal y = 20' >> $(TEST_SOURCE)
	@echo '' >> $(TEST_SOURCE)
	@echo 'def topla(sayisal a, sayisal b) {' >> $(TEST_SOURCE)
	@echo '    sayisal sonuc = a + b' >> $(TEST_SOURCE)
	@echo '    return sonuc' >> $(TEST_SOURCE)
	@echo '}' >> $(TEST_SOURCE)
	@echo '' >> $(TEST_SOURCE)
	@echo 'def carpma(sayisal a, sayisal b) {' >> $(TEST_SOURCE)
	@echo '    return a * b' >> $(TEST_SOURCE)
	@echo '}' >> $(TEST_SOURCE)
	@echo '' >> $(TEST_SOURCE)
	@echo 'sayisal z = topla(x, y)' >> $(TEST_SOURCE)
	@echo 'sayisal w = carpma(x, 5)' >> $(TEST_SOURCE)
	@echo ""
	@echo "Test dosyasƒ± i√ßeriƒüi ($$(wc -c < $(TEST_SOURCE)) bytes):"
	@cat $(TEST_SOURCE)
	@echo ""
	@echo "---"
	@echo ""
	@echo "üî® Derleme ba≈ülƒ±yor..."
	./$(TARGET) $(TEST_SOURCE) $(TEST_ASM)
	@echo ""
	@echo "üìú √úretilen Assembly (ilk 50 satƒ±r):"
	@head -50 $(TEST_ASM)
	@echo "..."
	@echo ""
	@echo "üîß NASM ile assembly..."
	$(NASM) $(NASMFLAGS) $(TEST_ASM) -o $(TEST_OBJ)
	@echo "  ‚úÖ NASM: OK"
	@echo ""
	@echo "üîó Linking..."
	$(LD) $(TEST_OBJ) -o $(TEST_EXEC)
	@echo "  ‚úÖ Linking: OK"
	@echo ""
	@echo "üöÄ √áalƒ±≈ütƒ±rƒ±lƒ±yor..."
	./$(TEST_EXEC) && echo "  ‚úÖ Execution: OK (exit code $$?)" || echo "  ‚ùå Execution failed (exit code $$?)"
	@echo ""
	@echo "=========================================="
	@echo "  ‚úÖ TEST TAMAMLANDI"
	@echo "=========================================="

# Temizlik
clean:
	@echo "üßπ Temizlik yapƒ±lƒ±yor..."
	rm -f $(OBJECTS) $(TARGET) $(TEST_SOURCE) $(TEST_ASM) $(TEST_OBJ) $(TEST_EXEC)
	rm -f *.ll *.o test_* *.mlp
	@echo "‚úÖ Temizlendi!"

# LLVM test (YZ_61 - Phase 15)
test_llvm: $(TARGET)
	@echo "Testing LLVM backend with stdlib integration..."
	./$(TARGET) -c --backend=llvm $(file) $(file:.mlp=.ll)
	clang $(file:.mlp=.ll) \
		-L../../../../runtime/stdlib -lmlp_stdlib \
		-L../../../../runtime/sto -lsto_runtime -lm \
		-o $(file:.mlp=)
	./$(file:.mlp=)

.PHONY: all info test clean test_llvm
