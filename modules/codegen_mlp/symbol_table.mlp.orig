-- Symbol Table - Variable and function tracking for CodeGen
-- Phase 2 Part 1: CodeGen Infrastructure
-- YZ_09: 16 December 2025

-- Symbol sym_table entry: [name, type, llvm_name, scope_level]
-- Example: ["x", "numeric", "%x", 0]

-- Create empty symbol sym_table
function create_symbol_table() returns list
    list empty_table = []
    return empty_table
end_function

-- Add symbol to sym_table
-- Returns: new symbol sym_table
function add_symbol(list sym_table, string name, string type_str, string llvm_name, numeric scope) returns list
    list entry = [name, type_str, llvm_name, scope]
    list new_table = sym_table + [entry]
    return new_table
end_function

-- Find symbol in sym_table by name
-- Returns: symbol entry or empty list if not found
function find_symbol(list sym_table, string name) returns list
    numeric i = 0
    while i < length(sym_table)
        list entry = sym_table[i]
        string entry_name = entry[0]
        
        if entry_name == name then
            return entry
        end_if
        
        i = i + 1
    end_while
    
    list empty = []
    return empty
end_function

-- Get symbol type
function get_symbol_type(list entry) returns string
    if length(entry) > 0 then
        return entry[1]
    end_if
    return ""
end_function

-- Get symbol LLVM name
function get_symbol_llvm_name(list entry) returns string
    if length(entry) > 0 then
        return entry[2]
    end_if
    return ""
end_function

-- Get symbol scope
function get_symbol_scope(list entry) returns numeric
    if length(entry) > 0 then
        return entry[3]
    end_if
    return 0
end_function

-- Remove symbols at specific scope level
-- Returns: new symbol sym_table
function pop_scope(list sym_table, numeric scope_level) returns list
    list new_table = []
    numeric i = 0
    
    while i < length(sym_table)
        list entry = sym_table[i]
        numeric entry_scope = entry[3]
        
        if entry_scope < scope_level then
            new_table = new_table + [entry]
        end_if
        
        i = i + 1
    end_while
    
    return new_table
end_function

-- Count symbols in sym_table
function count_symbols(list sym_table) returns numeric
    return length(sym_table)
end_function

-- Tests
function test_create_table() returns numeric
    println("=== Test 1: Create Symbol Table ===")
    
    list sym_table = create_symbol_table()
    numeric count = count_symbols(sym_table)
    
    if count == 0 then
        println("✓ Empty symbol sym_table created")
    else
        println("✗ Symbol sym_table creation failed")
        return 0
    end_if
    
    println("")
    return 1
end_function

function test_add_symbol() returns numeric
    println("=== Test 2: Add Symbols ===")
    
    list sym_table = create_symbol_table()
    
    sym_table = add_symbol(sym_table, "x", "numeric", "%x", 0)
    sym_table = add_symbol(sym_table, "y", "numeric", "%y", 0)
    sym_table = add_symbol(sym_table, "name", "string", "%name", 0)
    
    numeric count = count_symbols(sym_table)
    
    if count == 3 then
        println("✓ Added 3 symbols successfully")
    else
        println("✗ Add symbol failed")
        return 0
    end_if
    
    println("")
    return 1
end_function

function test_find_symbol() returns numeric
    println("=== Test 3: Find Symbol ===")
    
    list sym_table = create_symbol_table()
    sym_table = add_symbol(sym_table, "x", "numeric", "%x", 0)
    sym_table = add_symbol(sym_table, "y", "boolean", "%y", 0)
    
    list found_x = find_symbol(sym_table, "x")
    list found_y = find_symbol(sym_table, "y")
    list found_z = find_symbol(sym_table, "z")
    
    if length(found_x) > 0 then
        println("✓ Found symbol 'x'")
    else
        println("✗ Failed to find symbol 'x'")
        return 0
    end_if
    
    if length(found_y) > 0 then
        println("✓ Found symbol 'y'")
    else
        println("✗ Failed to find symbol 'y'")
        return 0
    end_if
    
    if length(found_z) == 0 then
        println("✓ Symbol 'z' not found (correct)")
    else
        println("✗ Found non-existent symbol 'z'")
        return 0
    end_if
    
    println("")
    return 1
end_function

function test_symbol_info() returns numeric
    println("=== Test 4: Symbol Information ===")
    
    list sym_table = create_symbol_table()
    sym_table = add_symbol(sym_table, "counter", "numeric", "%counter", 1)
    
    list entry = find_symbol(sym_table, "counter")
    
    string sym_type = get_symbol_type(entry)
    string sym_llvm = get_symbol_llvm_name(entry)
    numeric sym_scope = get_symbol_scope(entry)
    
    if sym_type == "numeric" then
        println("✓ Symbol type: numeric")
    else
        println("✗ Symbol type wrong")
        return 0
    end_if
    
    if sym_llvm == "%counter" then
        println("✓ LLVM name: %counter")
    else
        println("✗ LLVM name wrong")
        return 0
    end_if
    
    if sym_scope == 1 then
        println("✓ Scope level: 1")
    else
        println("✗ Scope level wrong")
        return 0
    end_if
    
    println("")
    return 1
end_function

function test_scope_management() returns numeric
    println("=== Test 5: Scope Management ===")
    
    list sym_table = create_symbol_table()
    
    -- Global scope (0)
    sym_table = add_symbol(sym_table, "global_var", "numeric", "%global_var", 0)
    
    -- Function scope (1)
    sym_table = add_symbol(sym_table, "func_param", "numeric", "%func_param", 1)
    
    -- Block scope (2)
    sym_table = add_symbol(sym_table, "local_var", "numeric", "%local_var", 2)
    sym_table = add_symbol(sym_table, "temp", "numeric", "%temp", 2)
    
    numeric count_before = count_symbols(sym_table)
    
    if count_before == 4 then
        println("✓ All 4 symbols added")
    else
        println("✗ Symbol count wrong before pop")
        return 0
    end_if
    
    -- Pop scope 2 (remove local variables)
    sym_table = pop_scope(sym_table, 2)
    numeric count_after = count_symbols(sym_table)
    
    if count_after == 2 then
        println("✓ Scope 2 popped, 2 symbols remaining")
    else
        println("✗ Scope pop failed")
        return 0
    end_if
    
    -- Verify remaining symbols
    list global = find_symbol(sym_table, "global_var")
    list func = find_symbol(sym_table, "func_param")
    list local = find_symbol(sym_table, "local_var")
    
    if length(global) > 0 and length(func) > 0 and length(local) == 0 then
        println("✓ Correct symbols remain after scope pop")
    else
        println("✗ Wrong symbols after scope pop")
        return 0
    end_if
    
    println("")
    return 1
end_function

function main() returns numeric
    println("╔══════════════════════════════════════════╗")
    println("║  Symbol Table Test Suite - YZ_09        ║")
    println("╚══════════════════════════════════════════╝")
    println("")
    
    numeric r1 = test_create_table()
    numeric r2 = test_add_symbol()
    numeric r3 = test_find_symbol()
    numeric r4 = test_symbol_info()
    numeric r5 = test_scope_management()
    
    if r1 == 1 and r2 == 1 and r3 == 1 and r4 == 1 and r5 == 1 then
        println("╔══════════════════════════════════════════╗")
        println("║  ✅ ALL TESTS PASSED (5/5)               ║")
        println("╚══════════════════════════════════════════╝")
        return 0
    else
        println("╔══════════════════════════════════════════╗")
        println("║  ✗ SOME TESTS FAILED                    ║")
        println("╚══════════════════════════════════════════╝")
        return 1
    end_if
end_function
